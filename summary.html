<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>สรุปออเดอร์ (สำหรับแอดมิน)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --pad: 16px; --radius: 12px; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; padding: var(--pad); background:#fafafa; color:#222; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    h2 { font-size: 16px; margin: 0; }
    .row { margin-bottom: 12px; }
    .card { background:#fff; border-radius:var(--radius); padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.06); margin-bottom:12px; }
    .totals { display:grid; grid-template-columns: 1fr auto; gap:8px; }
    .totals .label { color:#555; }
    .totals .value { text-align:right; font-weight:700; }
    .saving { color:#0a7c2f; font-weight:700; }
    .muted { color:#666; font-size:12px; }
    .hidden { display:none; }
    .inline-controls { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .inline-controls h2 { margin-right:auto; }
    .btn { padding:10px 14px; border:none; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn-primary { background:#1DB446; color:#fff; }
    .btn-secondary { background:#e9ecef; }
    .btn-lg { width:100%; padding:14px; font-size:18px; }
    .btn-18 { font-size:18px; }
    table { width:100%; border-collapse: collapse; }
    thead th { text-align:left; font-weight:600; font-size:13px; color:#555; border-bottom:1px solid #eee; padding:8px; }
    tbody td { padding:8px; border-bottom:1px dashed #eee; vertical-align:middle; }
    .num { text-align:right; font-variant-numeric: tabular-nums; }
    .inp-wrap { display:flex; align-items:center; justify-content:flex-end; gap:6px; }
    input[type="number"] {
      width: 78px;              /* แคบลง */
      padding:4px 6px;
      border:1px solid #ddd;
      border-radius:8px;
      font-size:20px;           /* ตัวเลขใหญ่ 20px */
      text-align:right;
    }
    .inputs-row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .title-row { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    pre { background:#f6f8fa; padding:12px; border-radius:8px; white-space:pre-wrap; }
    .right { text-align:right; }
    .actions-inline { display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap; }
    .copy-inline { margin-left: auto; }
  </style>
</head>
<body>
  <h1>สรุปออเดอร์ (สำหรับแอดมิน)</h1>

  <div id="status" class="row card">กำลังโหลด...</div>

  <div id="wrap" class="hidden">
    <div class="card">
      <div class="row"><strong>Order ID:</strong> <span id="oid">-</span></div>
      <div class="row totals">
        <div class="label">ยอดรวมเดิม</div><div class="value" id="sumOriginal">-</div>
        <div class="label">ยอดรวมหลังส่วนลด</div><div class="value" id="sumDiscounted">-</div>
        <div class="label">ส่วนต่างที่ประหยัด</div><div class="value saving" id="sumSaving">-</div>
      </div>
    </div>

    <div class="card">
      <!-- หัวข้อ + ควบคุมส่วนลดในบรรทัดเดียว -->
      <div class="inline-controls row">
        <h2>ส่วนลด</h2>
        <div class="inp-wrap">
          <input id="bulkDiscount" type="number" min="0" max="100" step="0.1" placeholder="%" />
          <span>%</span>
        </div>
        <button class="btn btn-secondary btn-18" id="applyBulk">Apply All</button>
        <button class="btn btn-secondary btn-18" id="resetDiscounts">Reset</button>
      </div>

      <div class="row"><strong>รายละเอียดคำสั่งซื้อ</strong></div>

      <div class="row" style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>ชื่อสินค้า</th>
              <th class="num">จำนวน</th>
              <th class="num">ยอดรวม</th>
              <th class="num">ส่วนลด (%)</th>
              <th class="num">ส่วนลด (฿)</th>
              <th class="num">ยอดใหม่</th>
            </tr>
          </thead>
          <tbody id="itemsBody"></tbody>
        </table>
      </div>

      <div class="row">
        <button class="btn btn-primary btn-lg" id="copyNew">คัดลอกสรุปราคาใหม่</button>
      </div>
    </div>

    <div class="card">
      <div class="title-row">
        <strong>ชื่อ-ที่อยู่จัดส่ง</strong>
        <button class="btn btn-secondary btn-18" id="copyAddress">คัดลอก</button>
      </div>
      <pre id="customerText" style="margin-top:8px;"></pre>

      <div class="actions-inline">
        <button class="btn btn-secondary btn-18" id="closeWindow">ปิดหน้าต่าง</button>
        <button class="btn btn-primary btn-18" id="sendBack">ส่งกลับ</button>
      </div>
    </div>
  </div>

  <script>
    // === CONFIG ===
    const GAS_STORE_URL = "https://script.google.com/macros/s/AKfycbyayDr5PzcycTz08NQ0tEivQyKK57kQ7qQxL9ZDrAtcz3JkjNbLEBPkAOcUErtA6DOewg/exec";
    const LIFF_ID = "2007887429-p3nd4dvE"; // แก้ให้ตรง LIFF ของ summary

    // ===== Utilities =====
    const fmt = (n) => Number(n||0).toLocaleString('th-TH');
    const clamp = (v,min,max) => Math.max(min, Math.min(max, v));

    function readParams() {
      const out = { id: null, d: null };
      const qs1 = new URLSearchParams(location.search);
      out.id = qs1.get('id'); out.d = qs1.get('d');

      const stateRaw = qs1.get('liff.state');
      if ((!out.id || !out.d) && stateRaw) {
        const state = decodeURIComponent(stateRaw);
        const qIdx = state.indexOf('?');
        if (qIdx >= 0) {
          const qs2 = new URLSearchParams(state.slice(qIdx));
          out.id = out.id || qs2.get('id');
          out.d  = out.d  || qs2.get('d');
        }
        if ((!out.id || !out.d) && state.includes('#')) {
          const afterHash = state.split('#')[1];
          const qs3 = new URLSearchParams(afterHash.startsWith('?') ? afterHash : '?' + afterHash);
          out.id = out.id || qs3.get('id');
          out.d  = out.d  || qs3.get('d');
        }
      }
      if ((!out.id || !out.d) && location.hash) {
        const qs4 = new URLSearchParams(location.hash.replace(/^#/, '?'));
        out.id = out.id || qs4.get('id');
        out.d  = out.d  || qs4.get('d');
      }
      return out;
    }

    // ===== Data / State =====
    let state = {
      orderId: null,
      customerText: "",
      items: [],           // [{name, price, qty, discountPct, discountAbs, lastEdited}]
      sumOriginal: 0,
      sumDiscounted: 0
    };

    // ===== Load from GAS =====
    async function loadByOrderId(orderId) {
      const resp = await fetch(GAS_STORE_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action: "getOrder", id: orderId })
      });
      const json = await resp.json().catch(() => null);
      if (!json || json.status !== "ok") {
        document.getElementById('status').innerHTML = 'โหลดออเดอร์ไม่สำเร็จ';
        return;
      }
      const o = json.order || {};
      const items = Array.isArray(o.items) ? o.items.map(it => ({
        name: String(it.name || ''),
        price: Number(it.price || 0),
        qty: Number(it.qty || 0),
        discountPct: 0,
        discountAbs: 0,
        lastEdited: null
      })) : [];

      state.orderId = o.orderId || "";
      state.customerText = o.customerText || "";
      state.items = items;
      renderAll();
    }

    // ===== Render =====
    function renderAll() {
      // ยอดรวมเดิม
      state.sumOriginal = state.items.reduce((s, it) => s + (it.price * it.qty), 0);
      state.sumDiscounted = state.sumOriginal;

      document.getElementById('oid').textContent = state.orderId || "-";
      document.getElementById('sumOriginal').textContent = fmt(state.sumOriginal) + " บาท";
      document.getElementById('sumDiscounted').textContent = fmt(state.sumDiscounted) + " บาท";
      document.getElementById('sumSaving').textContent = "0 บาท";

      document.getElementById('customerText').textContent = state.customerText || "";

      const tbody = document.getElementById('itemsBody');
      tbody.innerHTML = "";
      state.items.forEach((it, idx) => {
        const tr = document.createElement('tr');

        // ชื่อสินค้า
        const tdName = document.createElement('td');
        tdName.textContent = it.name;

        // จำนวน
        const tdQty = document.createElement('td');
        tdQty.className = "num";
        tdQty.textContent = fmt(it.qty);

        // ยอดรวมเดิม (price * qty)
        const tdSum = document.createElement('td');
        tdSum.className = "num";
        const original = it.price * it.qty;
        tdSum.textContent = fmt(original);

        // ส่วนลด (%)
        const tdDiscPct = document.createElement('td');
        tdDiscPct.className = "num";
        const inpPct = document.createElement('input');
        inpPct.type = "number"; inpPct.min = "0"; inpPct.max = "100"; inpPct.step = "0.1";
        inpPct.value = it.discountPct || 0;
        inpPct.addEventListener('input', () => {
          it.discountPct = clamp(Number(inpPct.value || 0), 0, 100);
          it.lastEdited = 'pct';
          // sync abs
          it.discountAbs = Math.round(original * it.discountPct / 100);
          inpAbs.value = it.discountAbs;
          recompute();
        });
        tdDiscPct.appendChild(inpPct);

        // ส่วนลด (฿)
        const tdDiscAbs = document.createElement('td');
        tdDiscAbs.className = "num";
        const inpAbs = document.createElement('input');
        inpAbs.type = "number"; inpAbs.min = "0"; inpAbs.step = "1";
        inpAbs.value = it.discountAbs || 0;
        inpAbs.addEventListener('input', () => {
          it.discountAbs = clamp(Math.round(Number(inpAbs.value || 0)), 0, original);
          it.lastEdited = 'abs';
          // sync pct (1 ตำแหน่งทศนิยม)
          it.discountPct = original ? Math.round((it.discountAbs / original) * 1000) / 10 : 0;
          inpPct.value = it.discountPct;
          recompute();
        });
        tdDiscAbs.appendChild(inpAbs);

        // ยอดใหม่ (คำนวณภายหลัง)
        const tdNew = document.createElement('td');
        tdNew.className = "num";
        tdNew.dataset.role = "after";
        tdNew.dataset.index = String(idx);

        tr.appendChild(tdName);
        tr.appendChild(tdQty);
        tr.appendChild(tdSum);
        tr.appendChild(tdDiscPct);
        tr.appendChild(tdDiscAbs);
        tr.appendChild(tdNew);
        tbody.appendChild(tr);
      });

      // ปุ่มควบคุมส่วนลดรวม
      document.getElementById('applyBulk').onclick = () => {
        const v = clamp(Number(document.getElementById('bulkDiscount').value || 0), 0, 100);
        state.items.forEach((it, idx) => {
          const original = it.price * it.qty;
          it.discountPct = v;
          it.discountAbs = Math.round(original * v / 100);
          it.lastEdited = 'pct';
        });
        // sync inputs
        const rows = document.querySelectorAll('#itemsBody tr');
        rows.forEach((row, i) => {
          const inputs = row.querySelectorAll('input[type="number"]');
          // assume order: pct then abs
          inputs[0].value = state.items[i].discountPct;
          inputs[1].value = state.items[i].discountAbs;
        });
        recompute();
      };

      document.getElementById('resetDiscounts').onclick = () => {
        state.items.forEach(it => { it.discountPct = 0; it.discountAbs = 0; it.lastEdited = null; });
        document.getElementById('bulkDiscount').value = "";
        document.querySelectorAll('#itemsBody input[type="number"]').forEach(inp => inp.value = "0");
        recompute();
      };

      document.getElementById('copyNew').onclick = copyNewSummary;
      document.getElementById('copyAddress').onclick = () => copyText(state.customerText || "");

      document.getElementById('closeWindow').onclick = () => {
        if (window.liff && liff.isInClient && liff.isInClient()) liff.closeWindow();
        else window.close();
      };

      document.getElementById('sendBack').onclick = sendBackToChat;

      document.getElementById('status').classList.add('hidden');
      document.getElementById('wrap').classList.remove('hidden');

      recompute();
    }

    function recompute() {
      let sum = 0;
      state.items.forEach((it, idx) => {
        const original = it.price * it.qty;
        // กำหนด source ของส่วนลดตามช่องที่แก้ล่าสุด
        let discAbs = 0;
        if (it.lastEdited === 'abs') {
          discAbs = clamp(Math.round(it.discountAbs || 0), 0, original);
          it.discountPct = original ? Math.round((discAbs / original) * 1000) / 10 : 0;
        } else { // 'pct' หรือ null -> ใช้ pct เป็นหลัก
          it.discountPct = clamp(Number(it.discountPct || 0), 0, 100);
          discAbs = Math.round(original * it.discountPct / 100);
          it.discountAbs = discAbs;
        }
        const after = Math.max(0, original - discAbs);
        sum += after;

        const cell = document.querySelector(`td[data-role="after"][data-index="${idx}"]`);
        if (cell) cell.textContent = fmt(after);
      });
      state.sumDiscounted = sum;

      document.getElementById('sumDiscounted').textContent = fmt(sum) + " บาท";
      const saving = Math.max(0, state.sumOriginal - sum);
      document.getElementById('sumSaving').textContent = fmt(saving) + " บาท";
    }

    function copyNewSummary() {
      const lines = [];
      lines.push(`สรุปออเดอร์ (หลังส่วนลด)`);
      lines.push(`Order ID: ${state.orderId || "-"}`);
      state.items.forEach(it => {
        const original = it.price * it.qty;
        const after = Math.max(0, original - (it.discountAbs || 0));
        const pct = clamp(Number(it.discountPct || 0), 0, 100);
        const abs = it.discountAbs || 0;
        lines.push(`• ${it.name} x${it.qty} = ${fmt(original)}฿ | -${fmt(abs)}฿ (${pct}%↓) = ${fmt(after)}฿`);
      });
      lines.push(`รวมทั้งหมดหลังลด: ${fmt(state.sumDiscounted)}฿`);
      copyText(lines.join('\n'));
    }

    async function copyText(text) {
      try { await navigator.clipboard.writeText(text); alert("คัดลอกแล้ว ✅"); }
      catch {
        const ta = document.createElement('textarea');
        ta.value = text; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); ta.remove();
        alert("คัดลอกแล้ว ✅");
      }
    }

    // ส่ง Flex กลับห้องแชท
    async function sendBackToChat() {
      const lines = state.items.map(it => {
        const original = it.price * it.qty;
        const after = Math.max(0, original - (it.discountAbs || 0));
        return {
          type: "box",
          layout: "horizontal",
          contents: [
            { type: "text", text: `${it.name} x${it.qty}`, size: "sm", wrap: true, flex: 2 },
            { type: "text", text: `${fmt(after)}฿`, size: "sm", align: "end", flex: 1 }
          ]
        };
      });

      // จำกัดจำนวนแสดงใน Flex (กันยาวเกิน)
      const MAX = 10;
      const shown = lines.slice(0, MAX);
      if (lines.length > MAX) {
        shown.push({ type:"text", text:`...และอีก ${lines.length-MAX} รายการ`, size:"sm", color:"#888888" });
      }

      const flex = {
        type: "flex",
        altText: `สรุปราคาใหม่: ${fmt(state.sumDiscounted)}฿`,
        contents: {
          type: "bubble",
          body: {
            type: "box",
            layout: "vertical",
            contents: [
              { type: "text", text: "สรุปราคาใหม่", weight: "bold", size: "lg" },
              { type: "text", text: `Order ID: ${state.orderId || "-"}`, size: "sm", color: "#666666", margin: "sm" },
              { type: "box", layout: "vertical", margin: "md", spacing: "sm", contents: shown },
              { type: "separator", margin: "md" },
              {
                type: "box",
                layout: "horizontal",
                margin: "md",
                contents: [
                  { type: "text", text: "รวมทั้งหมด", weight: "bold" },
                  { type: "text", text: `${fmt(state.sumDiscounted)}฿`, align: "end", weight: "bold" }
                ]
              }
            ]
          }
        }
      };

      try {
        if (liff.isInClient()) {
          await liff.sendMessages([flex]);
          alert("ส่งกลับเข้าห้องแชทแล้ว ✅");
        } else if (liff.isApiAvailable && liff.isApiAvailable('shareTargetPicker')) {
          await liff.shareTargetPicker([flex]);
          alert("แชร์ไปยังแชทแล้ว ✅");
        } else {
          alert("โปรดเปิดหน้านี้จากใน LINE เพื่อส่งข้อความกลับห้องแชท");
        }
      } catch (e) {
        alert("ส่งกลับไม่สำเร็จ: " + (e?.message || e));
      }
    }

    // ===== Main =====
    (async function main(){
      try {
        const { id, d } = readParams();
        if (id) {
          await loadByOrderId(id);
        } else if (d) {
          // fallback base64
          try {
            const payload = JSON.parse(decodeURIComponent(escape(atob(d))));
            state.orderId = "(no-id)";
            state.customerText = payload.customerText || "";
            state.items = Array.isArray(payload.items) ? payload.items.map(it => ({
              name: String(it.name||''),
              price: Number(it.price||0),
              qty: Number(it.qty||0),
              discountPct: 0,
              discountAbs: 0,
              lastEdited: null
            })) : [];
            renderAll();
          } catch {
            document.getElementById('status').innerHTML = 'อ่านข้อมูล fallback ไม่สำเร็จ';
          }
        } else {
          document.getElementById('status').innerHTML = 'ไม่พบ Order ID';
        }
      } catch (e) {
        document.getElementById('status').innerHTML = 'เกิดข้อผิดพลาดในการโหลด';
      }
    })();
  </script>

  <!-- LIFF SDK (สำหรับปิดหน้าต่าง/ส่งข้อความกลับแชท) -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    liff.init({ liffId: LIFF_ID }).catch(()=>{});
  </script>
</body>
</html>
