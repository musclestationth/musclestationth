<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>MuscleStationTH</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>

    :root { --pad: 16px; --radius: 12px; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; padding: var(--pad); background:#fafafa; color:#222; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    h2 { font-size: 16px; margin: 0; }
    .row { margin-bottom: 12px; }
    .card { background:#fff; border-radius:var(--radius); padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.06); margin-bottom:12px; }

    .totals { display:grid; grid-template-columns: 1fr auto; gap:8px; }
    .totals .label { color:#555; }
    .totals .value { text-align:right; font-weight:700; }
    .saving { color:#0a7c2f; font-weight:700; }

    .hidden { display:none; }

    .inline-controls { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .inline-controls h2 { margin: 0 6px 0 0; }

    .btn { padding:10px 14px; border:none; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn-primary { background:#1DB446; color:#fff; }
    .btn-secondary { background:#e9ecef; }
    .btn-18 { font-size:18px; }
    .btn-lg { width:100%; padding:14px; font-size:18px; }

    table { width:100%; border-collapse: collapse; font-size: 13px; }
    thead th { text-align:left; font-weight:600; font-size:12px; color:#555; border-bottom:1px solid #eee; padding:6px; }
    tbody td { font-size:13px; padding:6px; border-bottom:1px dashed #eee; vertical-align:middle; }
    .num { text-align:right; font-variant-numeric: tabular-nums; }

    .inp-wrap { display:flex; align-items:center; justify-content:flex-end; gap:6px; }
    input[type="number"] {
      padding:4px 6px;
      border:1px solid #ddd;
      border-radius:8px;
      font-size:20px;           /* ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏ç‡πà‡∏ï‡∏≤‡∏°‡∏™‡πÄ‡∏õ‡∏Ñ */
      text-align:right;
    }
    /* ‡πÅ‡∏Ñ‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î */
    #bulkDiscount { width: 40px; }
    #itemsBody td:nth-child(4) input { width: 40px; }  /* ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (%) */
    #itemsBody td:nth-child(5) input { width: 40px; }  /* ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡∏ø) */
    #newSummaryText {  font-size: 18px; }
    #newSummaryCard { font-size: 22px;}
    #customerText { font-size: 18px;}
    #sumOriginal {font-size: 18px; font-weight: bold; }
    #sumDiscounted {font-size: 22px;font-weight: bold;  }
    #sendBack:disabled {
      background: #9e9e9e !important;
      color: #fff !important;
      border-color: #9e9e9e !important;
      opacity: 1;              /* ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ */
      cursor: not-allowed;
    }

    .title-row { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    pre { background:#f6f8fa; padding:12px; border-radius:8px; white-space:pre-wrap; }
    .actions-inline{
      display: flex;
      flex-direction: column;   /* ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á: ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô, ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏≠‡∏¢‡∏π‡πà‡∏•‡πà‡∏≤‡∏á */
      gap: 10px;
      align-items: stretch;     /* ‡πÉ‡∏´‡πâ‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏á‡∏¢‡∏∑‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πâ */
    }



    /* ‡∏õ‡∏∏‡πà‡∏° "‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö" ‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ (‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏á) */
    #sendBack{
      display: block;
      width: 100%;
    }

    /* --- Admin PIN Gate --- */
    .gate { position: fixed; inset: 0; background: rgba(0,0,0,.5);
      display:flex; align-items:center; justify-content:center; z-index: 9999; }
    .gate.hidden { display:none; }
    .gate-card { background:#fff; border-radius:12px; padding:20px; width:92%; max-width:360px;
      box-shadow:0 10px 30px rgba(0,0,0,.2); text-align:center; }
    .gate-card input { width: 140px; text-align:center; font-size:22px; letter-spacing:4px;
      padding:8px 10px; border:1px solid #ddd; border-radius:8px; }
    .error { color:#dc3545; margin-top:8px; font-size:13px; }

    
  </style>
</head>
<body>
  <h1>‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)</h1>
  <!-- PIN Gate -->
  <div id="adminGate" class="gate">
    <div class="gate-card">
      <h2>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h2>
      <p style="margin:6px 0 12px;">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ 4 ‡∏´‡∏•‡∏±‡∏Å</p>
      <input id="adminPin" type="password" inputmode="numeric" pattern="\d*" maxlength="4" placeholder="____" />
      <button id="adminEnter" type="button" class="btn btn-primary" style="margin-top:10px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤</button>

      <div id="pinError" class="error hidden">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>
    </div>
  </div>

  <div id="status" class="row card">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

  <div id="wrap" class="hidden">


    <div class="card">
      <!-- ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ + ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß -->
      <div class="inline-controls row">
        <h2>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</h2>
        <div class="inp-wrap">
          <input id="bulkDiscount" type="number" min="0" max="100" step="0.1" />
          <span>%</span>
        </div>
        <button class="btn btn-secondary btn-18" id="applyBulk">Apply All</button>
        <button class="btn btn-secondary btn-18" id="resetDiscounts">Reset</button>
      </div>

     

      <div class="row" style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
              <th class="num">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
              <th class="num">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
              <th class="num">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (%)</th>
              <th class="num">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡∏ø)</th>
              <th class="num">‡∏¢‡∏≠‡∏î‡πÉ‡∏´‡∏°‡πà</th>
            </tr>
          </thead>
          <tbody id="itemsBody"></tbody>
        </table>
      </div>

      <div class="row totals">
        <div class="label" style="font-size:18px; font-weight: bold; color: #000000;" >‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÄ‡∏î‡∏¥‡∏°</div><div class="value" id="sumOriginal">-</div>
        <div class="label" style="font-size:22px; font-weight: bold; color:#0a7c2f">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÉ‡∏´‡∏°‡πà</div><div class="value saving" id="sumDiscounted">-</div>
      </div>


      
    </div>
    
    

  



    

    <div class="card">
      <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà (‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô card ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà) -->
      <div id="newSummaryCard" class="hidden" padding-top:12px; margin-top:4px;">
        <div class="title-row">
          <strong>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà</strong>
          <button class="btn btn-secondary btn-18" id="copyNewInline">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
        </div>
        <pre id="newSummaryText" style="margin-top:8px;"></pre>
      </div>

      <div class="actions-inline">
        <button class="btn btn-primary btn-18" id="sendBack">‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö</button>
      </div>

      <div class="title-row" style="margin-top:12px;">
        <strong style="font-size:22px;">‡∏ä‡∏∑‡πà‡∏≠-‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</strong>
        <button class="btn btn-secondary btn-18" id="copyAddress">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
      </div>
      <pre id="customerText" style="margin-top:8px;"></pre>

    </div>

  </div>

  <script>
    // ===== ADMIN PIN (4 ‡∏´‡∏•‡∏±‡∏Å) =====
    const ADMIN_PIN = "0888"; // <<< ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
    const ADMIN_OK_KEY = "ADMIN_OK_SUMMARY"; // sessionStorage key

    // === CONFIG ===
    const GAS_STORE_URL = "https://script.google.com/macros/s/AKfycbyayDr5PzcycTz08NQ0tEivQyKK57kQ7qQxL9ZDrAtcz3JkjNbLEBPkAOcUErtA6DOewg/exec";
    const LIFF_ID = "2007887429-p3nd4dvE"; // LIFF ‡∏Ç‡∏≠‡∏á summary

    // ===== Utilities =====
    const fmt = (n) => Number(n||0).toLocaleString('th-TH');
    const clamp = (v,min,max) => Math.max(min, Math.min(max, v));

    function readParams() {
      const out = { id: null, d: null };
      const qs1 = new URLSearchParams(location.search);
      out.id = qs1.get('id'); out.d = qs1.get('d');

      const stateRaw = qs1.get('liff.state');
      if ((!out.id || !out.d) && stateRaw) {
        const state = decodeURIComponent(stateRaw);
        const qIdx = state.indexOf('?');
        if (qIdx >= 0) {
          const qs2 = new URLSearchParams(state.slice(qIdx));
          out.id = out.id || qs2.get('id');
          out.d  = out.d  || qs2.get('d');
        }
        if ((!out.id || !out.d) && state.includes('#')) {
          const afterHash = state.split('#')[1];
          const qs3 = new URLSearchParams(afterHash.startsWith('?') ? afterHash : '?' + afterHash);
          out.id = out.id || qs3.get('id');
          out.d  = out.d  || qs3.get('d');
        }
      }
      if ((!out.id || !out.d) && location.hash) {
        const qs4 = new URLSearchParams(location.hash.replace(/^#/, '?'));
        out.id = out.id || qs4.get('id');
        out.d  = out.d  || qs4.get('d');
      }
      return out;
    }

    // ===== Data / State =====
    let state = {
      orderId: null,
      customerText: "",
      items: [],           // [{name, price, qty, discountPct, discountAbs}]
      sumOriginal: 0,
      sumDiscounted: 0
    };

    // ===== Load from GAS =====
    async function loadByOrderId(orderId) {
      const resp = await fetch(GAS_STORE_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action: "getOrder", id: orderId })
      });
      const json = await resp.json().catch(() => null);
      if (!json || json.status !== "ok") {
        document.getElementById('status').innerHTML = '‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
        return;
      }
      const o = json.order || {};
      const items = Array.isArray(o.items) ? o.items.map(it => ({
        name: String(it.name || ''),
        price: Number(it.price || 0),
        qty:   Number(it.qty   || 0),
        discountPct: null,   // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡πà‡∏≤‡∏á
        discountAbs: null    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡πà‡∏≤‡∏á
      })) : [];

      state.orderId = o.orderId || "";
      state.customerText = o.customerText || "";
      state.items = items;
      renderAll();
    }

    // ===== Render =====
    function renderAll() {
      // ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÄ‡∏î‡∏¥‡∏°
      state.sumOriginal = state.items.reduce((s, it) => s + (it.price * it.qty), 0);
      state.sumDiscounted = state.sumOriginal;

      document.getElementById('sumOriginal').textContent = fmt(state.sumOriginal) + " ‡∏ö‡∏≤‡∏ó";
      document.getElementById('sumDiscounted').textContent = fmt(state.sumDiscounted) + " ‡∏ö‡∏≤‡∏ó";

      document.getElementById('customerText').textContent = state.customerText || "";

      const tbody = document.getElementById('itemsBody');
      tbody.innerHTML = "";
      state.items.forEach((it, idx) => {
        const tr = document.createElement('tr');

        // ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        const tdName = document.createElement('td');
        tdName.textContent = it.name;

        // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
        const tdQty = document.createElement('td');
        tdQty.className = "num";
        tdQty.textContent = fmt(it.qty);

        // ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÄ‡∏î‡∏¥‡∏° (price * qty)
        const tdSum = document.createElement('td');
        tdSum.className = "num";
        const original = it.price * it.qty;
        tdSum.textContent = fmt(original);

        // ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (%)
        const tdDiscPct = document.createElement('td');
        tdDiscPct.className = "num";
        const inpPct = document.createElement('input');
        inpPct.type = "number"; inpPct.min = "0"; inpPct.max = "100"; inpPct.step = "0.1";
        inpPct.value = (it.discountPct == null) ? "" : it.discountPct;   // ‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏Å‡∏£‡∏≠‡∏Å
        inpPct.addEventListener('input', () => {
          const raw = inpPct.value;
          if (raw === "" || raw === null) it.discountPct = null;
          else it.discountPct = clamp(Number(raw), 0, 100);
          // ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞‡∏ï‡πâ‡∏≠‡∏á discountAbs
          recompute();
        });
        tdDiscPct.appendChild(inpPct);

        // ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡∏ø)
        const tdDiscAbs = document.createElement('td');
        tdDiscAbs.className = "num";
        const inpAbs = document.createElement('input');
        inpAbs.type = "number"; inpAbs.min = "0"; inpAbs.step = "1";
        inpAbs.value = (it.discountAbs == null) ? "" : it.discountAbs;   // ‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏Å‡∏£‡∏≠‡∏Å
        inpAbs.addEventListener('input', () => {
          const raw = inpAbs.value;
          const originalRow = it.price * it.qty;
          if (raw === "" || raw === null) it.discountAbs = null;
          else it.discountAbs = clamp(Math.round(Number(raw)), 0, originalRow);
          // ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞‡∏ï‡πâ‡∏≠‡∏á discountPct
          recompute();
        });
        tdDiscAbs.appendChild(inpAbs);

        // ‡∏¢‡∏≠‡∏î‡πÉ‡∏´‡∏°‡πà (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á)
        const tdNew = document.createElement('td');
        tdNew.className = "num";
        tdNew.dataset.role = "after";
        tdNew.dataset.index = String(idx);

        tr.appendChild(tdName);
        tr.appendChild(tdQty);
        tr.appendChild(tdSum);
        tr.appendChild(tdDiscPct);
        tr.appendChild(tdDiscAbs);
        tr.appendChild(tdNew);
        tbody.appendChild(tr);
      });

      // ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏£‡∏ß‡∏°
      document.getElementById('applyBulk').onclick = () => {
        const v = clamp(Number(document.getElementById('bulkDiscount').value || 0), 0, 100);
        state.items.forEach((it) => {
          it.discountPct = v;          // set ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ %
          // ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞‡∏ï‡πâ‡∏≠‡∏á it.discountAbs
        });
        // sync ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ input ‡∏ä‡πà‡∏≠‡∏á %
        const rows = document.querySelectorAll('#itemsBody tr');
        rows.forEach((row, i) => {
          const inputs = row.querySelectorAll('input[type="number"]'); // [pct, abs]
          if (inputs[0]) inputs[0].value = (state.items[i].discountPct ?? "");
        });
        recompute();
      };

      document.getElementById('resetDiscounts').onclick = () => {
        state.items.forEach(it => { it.discountPct = null; it.discountAbs = null; });
        document.getElementById('bulkDiscount').value = "";
        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏∏‡∏Å input ‡πÉ‡∏´‡πâ "‡∏ß‡πà‡∏≤‡∏á"
        document.querySelectorAll('#itemsBody input[type="number"]').forEach(inp => inp.value = "");
        recompute();
      };

      document.getElementById('copyAddress').onclick = () => copyText(state.customerText || "");



      document.getElementById('sendBack').onclick = sendBackToChat;

      document.getElementById('status').classList.add('hidden');
      document.getElementById('wrap').classList.remove('hidden');

      recompute();

      // ‡πÅ‡∏™‡∏î‡∏á "‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà" ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î/‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå
      const card = document.getElementById('newSummaryCard');
      const pre  = document.getElementById('newSummaryText');
      if (card && pre) {
        pre.textContent = buildNewSummaryText();
        card.classList.remove('hidden');
      }
    }

    function recompute() {
      let sum = 0;
      state.items.forEach((it, idx) => {
        const original = it.price * it.qty;

        // ‡πÉ‡∏ä‡πâ "‡∏ö‡∏≤‡∏ó" ‡∏Å‡πà‡∏≠‡∏ô ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≠‡∏¢‡πÉ‡∏ä‡πâ "%"
        const pct = clamp(Number(it.discountPct ?? 0), 0, 100);
        let   abs = clamp(Math.round(Number(it.discountAbs ?? 0)), 0, original);
        if (abs === 0 && pct > 0) abs = Math.round(original * pct / 100);

        const after = Math.max(0, original - abs);
        sum += after;

        const cell = document.querySelector(`td[data-role="after"][data-index="${idx}"]`);
        if (cell) cell.textContent = fmt(after);
      });

      state.sumDiscounted = sum;
      document.getElementById('sumDiscounted').textContent = fmt(sum) + " ‡∏ö‡∏≤‡∏ó";

      // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
      const newCard = document.getElementById('newSummaryCard');
      if (newCard && !newCard.classList.contains('hidden')) {
        document.getElementById('newSummaryText').textContent = buildNewSummaryText();
      }
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà (‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà Order ID)
    function buildNewSummaryText() {
      const lines = [];
    

      state.items.forEach(it => {
        const original = it.price * it.qty;
        const pct = clamp(Number(it.discountPct ?? 0), 0, 100);
        let   abs = clamp(Math.round(Number(it.discountAbs ?? 0)), 0, original);
        if (abs === 0 && pct > 0) abs = Math.round(original * pct / 100);

        const after = Math.max(0, original - abs);
        const label = abs > 0 ? `-${fmt(abs)}‡∏ø` : (pct > 0 ? `-${pct}%` : `-0‡∏ø`);
        lines.push(`‚Ä¢ ${it.name} x${it.qty} = ${fmt(original)}‡∏ø | ${label} = ${fmt(after)}‡∏ø`);
      });
      lines.push("");
      lines.push(`‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${fmt(state.sumDiscounted)}‡∏ø`);
      return lines.join('\n');
    }

    // ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ö‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î "‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà"
    document.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'copyNewInline') {
        const text = document.getElementById('newSummaryText').textContent || buildNewSummaryText();
        copyText(text);
      }
    });

    async function copyText(text) {
      try { await navigator.clipboard.writeText(text); alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ"); }
      catch {
        const ta = document.createElement('textarea');
        ta.value = text; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); ta.remove();
        alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
      }
    }

    // ‡∏™‡πà‡∏á Flex ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó
    // ‡∏™‡πà‡∏á Flex ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö checkout template ‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡πá‡∏ô "‡∏´‡∏•‡∏±‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î")
async function sendBackToChat() {
  // === ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏à‡∏≤‡∏Å state ===
  const lines = [];
  state.items.forEach(it => {
    const original = it.price * it.qty;
    const pct = clamp(Number(it.discountPct ?? 0), 0, 100);
    let   abs = clamp(Math.round(Number(it.discountAbs ?? 0)), 0, original);
    if (abs === 0 && pct > 0) abs = Math.round(original * pct / 100);
    const after = Math.max(0, original - abs);
    const label = abs > 0 ? `-${fmt(abs)}‡∏ø` : (pct > 0 ? `-${pct}%` : `-0‡∏ø`);
    lines.push(`${it.name} x${it.qty} = ${fmt(original)}‡∏ø | ${label} = ${fmt(after)}‡∏ø`);
  });

  const orderText =
    `üì¶ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡∏´‡∏•‡∏±‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î)\n` +
    lines.map(l => `‚Ä¢ ${l}`).join('\n') +
    `\n\n‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î = ${fmt(state.sumDiscounted)}‡∏ø`;

  // ‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡∏•‡∏¥‡∏°‡∏¥‡∏ï LINE (~2000 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)
  const splitTextByLimit = (t, limit = 1900) => {
    const out = [];
    for (let i = 0; i < t.length; i += limit) out.push(t.slice(i, i + limit));
    return out;
  };

  // ‚úÖ ‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ orderText
  const messages = splitTextByLimit(orderText).map(text => ({ type: "text", text }));

  // ---- ‡∏Ñ‡∏∏‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ----
  const btn = document.getElementById('sendBack');
  if (btn) {
    btn.dataset.prev = btn.textContent || "‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö";
    btn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";
    btn.disabled = true;
  }

  // ---- ‡∏¢‡∏¥‡∏á‡πÑ‡∏õ GAS (action: pushSummary) ----
  const controller = new AbortController();
  const tid = setTimeout(() => controller.abort(), 30000);

  try {
    const res = await fetch(GAS_STORE_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({
        action: "pushSummary",
        orderId: state.orderId,
        message: messages
      }),
      signal: controller.signal
    });
    clearTimeout(tid);

    const js = await res.json().catch(() => null);
    if (res.ok && js?.status === "ok") {
      if (btn) { btn.textContent = "‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß"; btn.disabled = true; }
    } else {
      if (btn) { btn.textContent = btn.dataset.prev || "‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö"; btn.disabled = false; }
      alert("‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (GAS): " + (js?.error || js?.message || res.status));
    }
  } catch (e) {
    clearTimeout(tid);
    const aborted = (e?.name === "AbortError") || /aborted/i.test(String(e?.message || e));
    if (aborted) {
      if (btn) { btn.textContent = "‡∏≠‡∏≤‡∏à‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏ä‡∏ó)"; btn.disabled = true; }
      alert("‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏ä‡πâ‡∏≤ ‡πÄ‡∏•‡∏¢‡∏ï‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå ‡πÅ‡∏ï‡πà‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó");
    } else {
      if (btn) { btn.textContent = btn.dataset.prev || "‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö"; btn.disabled = false; }
      alert("‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (e?.message || e));
    }
  }
}





    // ‡πÉ‡∏ä‡πâ sendBeacon ‡∏Å‡πà‡∏≠‡∏ô; ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏≠‡∏¢ fetch keepalive (‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà‡πÑ‡∏°‡πà await)
    function fireAndForgetToGAS(url, bodyStr) {
      try {
        if (navigator.sendBeacon) {
          const ok = navigator.sendBeacon(url, new Blob([bodyStr], { type: "text/plain;charset=utf-8" }));
          if (ok) return;
        }
      } catch (_) {}
      try {
        fetch(url, {
          method: "POST",
          body: bodyStr,
          keepalive: true,
          headers: { "Content-Type": "text/plain;charset=utf-8" }
        });
      } catch (_) {}
    }






    

    function showPinGate() {
      const gate = document.getElementById('adminGate');
      const inp  = document.getElementById('adminPin');
      const btn  = document.getElementById('adminEnter');
      const err  = document.getElementById('pinError');

      gate.classList.remove('hidden');
      setTimeout(()=> inp.focus(), 50);

      function tryUnlock() {
        const pin = String(inp.value || "").trim();
        if (pin === ADMIN_PIN) {
          sessionStorage.setItem(ADMIN_OK_KEY, "1");
          err.classList.add('hidden');
          gate.classList.add('hidden');
          startApp();            // ‚Üê ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤
        } else {
          err.classList.remove('hidden');
          inp.select();
        }
      }

      btn.onclick = tryUnlock;
      inp.onkeydown = (e) => { if (e.key === 'Enter') tryUnlock(); };
    }

    async function startApp(){
      (async function main(){
        try {
          const { id, d } = readParams();
          if (id) {
            await loadByOrderId(id);
          } else if (d) {
            // fallback base64
            try {
              const payload = JSON.parse(decodeURIComponent(escape(atob(d))));
              state.orderId = "(no-id)";
              state.customerText = payload.customerText || "";
              state.items = Array.isArray(payload.items) ? payload.items.map(it => ({
                name: String(it.name||''),
                price: Number(it.price||0),
                qty:   Number(it.qty||0),
                discountPct: null,
                discountAbs: null
              })) : [];
              renderAll();
            } catch {
              document.getElementById('status').innerHTML = '‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• fallback ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
            }
          } else {
            document.getElementById('status').innerHTML = '‡πÑ‡∏°‡πà‡∏û‡∏ö Order ID';
          }
        } catch (e) {
          document.getElementById('status').innerHTML = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î';
        }
      })();
    }
    // Boot: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡∏ô‡∏µ‡πâ ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡∏ñ‡∏≤‡∏° PIN
    (function boot(){
      if (sessionStorage.getItem(ADMIN_OK_KEY) === "1") {
        startApp();
      } else {
        showPinGate();
      }
    })();


    
  </script>

  <!-- LIFF SDK (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á/‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏ä‡∏ó) -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    liff.init({ liffId: LIFF_ID }).catch(()=>{});
  </script>
</body>
</html>
