        <!DOCTYPE html>
        <html lang="th">
        <head>
          <meta charset="UTF-8" />
          <title>สรุปออเดอร์ (สำหรับแอดมิน)</title>
          <meta name="viewport" content="width=device-width, initial-scale=1" />
          <style>
            body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; }
            h1 { font-size: 20px; margin-bottom: 12px; }
            pre { background: #f7f7f7; padding: 12px; border-radius: 8px; white-space: pre-wrap; }
            .row { margin-bottom: 12px; }
            .btn { padding: 10px 14px; border: none; border-radius: 8px; cursor: pointer; }
            .btn-primary { background: #1DB446; color: white; }
            .btn-secondary { background: #e0e0e0; }
          </style>
        </head>
        <body>
          <h1>สรุปออเดอร์ (สำหรับแอดมิน)</h1>
          <div id="status" class="row">กำลังโหลด...</div>

          <div id="wrap" style="display:none;">
            <div class="row"><strong>Order ID:</strong> <span id="oid"></span></div>
            <div class="row"><strong>ยอดรวม:</strong> <span id="total"></span> บาท</div>
            <div class="row"><strong>Order</strong><pre id="orderText"></pre></div>
            <div class="row"><strong>Customer</strong><pre id="customerText"></pre></div>
            <div class="row">
              <button class="btn btn-primary" id="copyAll">คัดลอกทั้งหมด</button>
              <button class="btn btn-secondary" id="closeWindow">ปิดหน้าต่าง</button>
            </div>
          </div>

          <script>
            // ใช้ GAS "ใหม่" ที่เก็บออเดอร์
            const GAS_STORE_URL = "https://script.google.com/macros/s/AKfycbyayDr5PzcycTz08NQ0tEivQyKK57kQ7qQxL9ZDrAtcz3JkjNbLEBPkAOcUErtA6DOewg/exec";

            // ✅ ดึงพารามิเตอร์จาก search, liff.state, และ hash
            function readParams() {
              const out = { id: null, d: null };

              // 1) จาก location.search ตรงๆ
              const qs1 = new URLSearchParams(location.search);
              out.id = qs1.get('id');
              out.d  = qs1.get('d');

              // 2) จาก liff.state (LIFF จะใส่ query เดิมไว้ในนี้)
              const stateRaw = qs1.get('liff.state');
              if ((!out.id || !out.d) && stateRaw) {
                const state = decodeURIComponent(stateRaw); // เช่น "/?id=ORD-xxx" หรือ "/path#/?id=..."
                // ดึงจากส่วนที่เป็น ?query
                const qIndex = state.indexOf('?');
                if (qIndex >= 0) {
                  const qs2 = new URLSearchParams(state.slice(qIndex));
                  out.id = out.id || qs2.get('id');
                  out.d  = out.d  || qs2.get('d');
                }
                // เผื่อบางเคสถูกเก็บหลัง # (hash)
                if ((!out.id || !out.d) && state.includes('#')) {
                  const afterHash = state.split('#')[1]; // เช่น "?id=..."
                  const qs3 = new URLSearchParams(afterHash.startsWith('?') ? afterHash : '?' + afterHash);
                  out.id = out.id || qs3.get('id');
                  out.d  = out.d  || qs3.get('d');
                }
              }

              // 3) จาก location.hash ของหน้า endpoint เอง
              if ((!out.id || !out.d) && location.hash) {
                const qs4 = new URLSearchParams(location.hash.replace(/^#/, '?'));
                out.id = out.id || qs4.get('id');
                out.d  = out.d  || qs4.get('d');
              }

              return out;
            }

            async function loadByOrderId(orderId) {
              const resp = await fetch(GAS_STORE_URL, {
                method: "POST",
                headers: { "Content-Type": "text/plain;charset=utf-8" }, // เลี่ยง preflight
                body: JSON.stringify({ action: "getOrder", id: orderId })
              });
              const json = await resp.json().catch(() => null);
              if (!json || json.status !== "ok") {
                document.getElementById('status').textContent = "โหลดออเดอร์ไม่สำเร็จ: " + (json?.message || "");
                return;
              }
              render(json.order);
            }

            function render(payload) {
              document.getElementById('oid').textContent = payload.orderId || "-";
              document.getElementById('total').textContent = (payload.totalPrice ?? 0).toLocaleString();
              document.getElementById('orderText').textContent = payload.orderText || "";
              document.getElementById('customerText').textContent = payload.customerText || "";
              document.getElementById('status').style.display = 'none';
              document.getElementById('wrap').style.display = 'block';
            }

            (async function main() {
              const { id, d } = readParams();

              if (id) {
                await loadByOrderId(id);
                return;
              }
              if (d) {
                // fallback base64
                try {
                  const payload = JSON.parse(decodeURIComponent(escape(atob(d))));
                  render({
                    orderId: "(no-id)",
                    orderText: payload.orderText || "",
                    customerText: payload.customerText || "",
                    totalPrice: payload.totalPrice || 0,
                    items: payload.items || []
                  });
                  return;
                } catch {
                  document.getElementById('status').textContent = "อ่านข้อมูล fallback ไม่สำเร็จ";
                  return;
                }
              }
              document.getElementById('status').textContent = "ไม่พบ Order ID";
            })();
          </script>


          <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
          <script>
            // init เงียบ ๆ ถ้า error ก็ไม่รบกวนผู้ใช้
            liff.init({ liffId: "2007887429-p3nd4dvE" }).catch(()=>{});
          </script>

        </body>
        </html>
